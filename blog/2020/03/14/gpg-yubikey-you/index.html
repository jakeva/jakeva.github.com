

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="HandheldFriendly" content="true">
    <title>
      
        GPG & YubiKey & You -
      
      Jake Van Alstyne
    </title>
    <meta name="description" content="In which I do interesting things with my YubiKey">
    <meta name="author" content="Jake Van Alstyne">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->


    <script src="/assets/themes/jakeva/js/jquery.min.js"></script>
    <script src="/assets/themes/jakeva/js/script.js"></script>
    <script src="/assets/themes/jakeva/bootstrap/js/bootstrap.min.js"></script>

    <link href="/assets/themes/jakeva/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/themes/jakeva/bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="/assets/themes/jakeva/css-social-buttons/css/zocial.stripped.css" />
    <link href="/assets/themes/jakeva/css/pygments.css" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/jakeva/css/style.css" rel="stylesheet" type="text/css" media="all">

  </head>

  <body>
    <div class="navbar">
      <div class="navbar-inner">
        <div class="container">
          <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>


          <a class="brand" href="/">Jake Van Alstyne</a>


          <div class="nav-collapse">
            <ul class="nav">
            
            
            


  
    
      
      	
      	<li><a href="/CV/">CV</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/contact/">Contact</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  



            </ul>
            <ul class="nav pull-right social visible-desktop">
              
                <li>
                  <a href="https://github.com/jakeva" class="zocial github icon" target="_blank">
                    <span class="hidden-desktop">Github</a>
                  </a>
                </li>
              
              
              
                <li>
                  <a href="https://twitter.com/jake_va" class="zocial twitter icon" target="_blank">
                  <span class="hidden-desktop">Twitter</a>
                  </a>
                </li>
              
              
              
                <li>
                  <a href="http://www.linkedin.com/in/jakeva" class="zocial linkedin icon" target="_blank">
                    <span class="hidden-desktop">LinkedIn</a>
                  </a>
                </li>
              
              
            </ul>
          </div>
        </div>
      </div>
    </div>

    <div class="content-container">
      <div class="content">
        

<div class="page-header">
  <h1>
    GPG & YubiKey & You
    
  </h1>
</div>

<div class="row">
  <span class="span10">
    <p>I’ve recently taken on the task of setting up my YubiKeys for usage beyond 2 factor auth. Something I learned was that OpenPGP smartcards (which include YubiKeys) have slots for three separate keys: Signature, Encryption, and Authentication.</p>

<p>My first goal is to sign git commits with it. Because I am a man of negligible importance, this is in fact NOT an excercise in security. I’m taking more of a hobbyist approach. If security was of a more significant concern in my life, I would probably generate my keys in a live booted and air gapped <a href="https://tails.boum.org">Tails</a> environment.</p>

<p>When I started going down this route I had only in the first place acquired my YubiKey to simplify 2 factor authorization, a flow that I have found myself increasingly spending time due to work and the fact I turn it on everywhere that supports it. I think I was vaguely aware they could be used for more. Regardless, I started by playing around with signing. One of the first things I became aware of was that these things have PIN codes. Never needed them for 2FA, but for managing GPG keys you do. The default user PIN (which is used for signing, among other things) is <code class="language-plaintext highlighter-rouge">123456</code> and the default admin PIN (used for modifying certain card attributes) is <code class="language-plaintext highlighter-rouge">12345678</code>.</p>

<p>If you’re following along, I’m assuming you have a YubiKey and a recent version of GnuPG.</p>

<h2 id="configure-your-yubikey">Configure your YubiKey</h2>
<p>To change the PIN (and configure things like your name, language, etc) run <code class="language-plaintext highlighter-rouge">gpg --card-edit</code> with your key plugged in. You should see information about your key. Type <code class="language-plaintext highlighter-rouge">admin</code> and <code class="language-plaintext highlighter-rouge">help</code> to enable and list the available commands. Use <code class="language-plaintext highlighter-rouge">passwd</code> to change the user PIN code.</p>

<h2 id="a-little-about-gpg-keys">A little about GPG keys</h2>
<p>GPG keys have capabilities: Sign, Certify, and Encrypt. When you generate a GPG public / private keypair, by default you get a primary pub/priv key and a sub pub/priv key. The primary key can Sign and Certify. The subkey can Encrypt. The reason for this default is that Certify is all powerful. It really is your identity. Delegating powers to other keys signed by it is a good way to reduce your security footprint. If someone steals your encrypt key, all you have to do is revoke it, create a new one, and Certify it with your unstolen primary key. If someone steals your primary private key, well they’ve just stolen the ability to revoke your other keys or make new keys as you. So keep it extra safe.</p>

<h2 id="create-a-gpg-key">Create a GPG key</h2>
<p>It’s time to generate your GPG key. <code class="language-plaintext highlighter-rouge">gpg --expert --full-gen-key</code></p>
<ul>
  <li>Select <code class="language-plaintext highlighter-rouge">RSA and RSA(default)</code></li>
  <li>Key size: depending on the version of your key
    <ul>
      <li>YubiKey NEO - 2048</li>
      <li>YubiKey 4 / 5 - 4096</li>
    </ul>
  </li>
  <li>Do it again for the subkey</li>
  <li>Pick an expiration date</li>
  <li>Enter your name (must be more than 5 characters)</li>
  <li>Enter your email</li>
  <li>Enter an optional comment</li>
</ul>

<p>Note the ID of the key generated. For fun, let’s look at what we’ve got so far. Run <code class="language-plaintext highlighter-rouge">gpg --edit-key &lt;KEY ID&gt;</code>. You should see something like</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Secret key is available.

gpg: checking the trustdb
gpg: marginals needed: 3  completes needed: 1  trust model: pgp
gpg: depth: 0  valid:   2  signed:   0  trust: 0-, 0q, 0n, 0m, 0f, 2u
gpg: next trustdb check due at 2021-03-12
sec  rsa4096/98973C978ECA988D
     created: 2020-03-14  expires: never       usage: SC
     trust: ultimate      validity: ultimate
ssb  rsa4096/015D68EE1E7AC274
     created: 2020-03-14  expires: never       usage: E
[ultimate] (1). Jake Van Alstyne (testing) &lt;email@address.org&gt;
</code></pre></div></div>

<p>The usage of the first key is marked as <code class="language-plaintext highlighter-rouge">SC</code>. The second is <code class="language-plaintext highlighter-rouge">E</code>. That means the primary key can sign and certify, while the subkey can encrypt.</p>

<p>If you have an existing key, you could use it to sign this new one to maintain a chain of custody: <code class="language-plaintext highlighter-rouge">gpg -u &lt;your_old_keyid&gt; --sign-key &lt;longid&gt;</code></p>

<p>While we’re here, let’s add separate authentication and signing keys to prepare to fill the slots on the YubiKey.</p>

<h3 id="authentication-key">Authentication Key</h3>
<p>If you’re still at the gpg prompt <code class="language-plaintext highlighter-rouge">gpg&gt;</code> from the last command, exit out with Ctrl-C or <code class="language-plaintext highlighter-rouge">quit</code> and enter <code class="language-plaintext highlighter-rouge">gpg --expert --edit-key &lt;KEY ID&gt;</code>. Notice the extra flag for expert. Now enter the command <code class="language-plaintext highlighter-rouge">addkey</code>.</p>
<ul>
  <li>Pick RSA.</li>
  <li>Toggle capabilities until only authentication is enabled. You should need to enter each option once: <code class="language-plaintext highlighter-rouge">S, E, A</code></li>
  <li>Enter <code class="language-plaintext highlighter-rouge">Q</code> to finish</li>
  <li>Pick the key size</li>
  <li>Pick the expiration (good idea to keep it the same as your master key)</li>
  <li>Follow the rest of the prompts</li>
</ul>

<h3 id="signing-key">Signing Key</h3>
<p>The steps are the same as for the authentication key, only you should only have to deselect Encrypt when picking the key capabilities since by default Signing and Encryption are selected.
If you <code class="language-plaintext highlighter-rouge">quit</code> out of here now, make sure to save or you’ll lose the keys you just made.</p>

<h2 id="backup-your-keys">Backup your keys</h2>
<p>It’s a good idea to keep a backup somewhere safe.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gpg --armor --output privkey.sec --export-secret-key &lt;longid&gt;
gpg --armor --output subkeys.sec --export-secret-subkeys &lt;longid&gt;
gpg --armor --output pubkey.asc --export &lt;longid&gt;
</code></pre></div></div>

<h2 id="import-key-to-yubikey">Import key to YubiKey</h2>
<p>Make sure the YubiKey is plugged into your computer. Edit the key again, if you aren’t already <code class="language-plaintext highlighter-rouge">gpg --edit-key &lt;KEY ID&gt;</code>. Enter the command <code class="language-plaintext highlighter-rouge">toggle</code> followed by <code class="language-plaintext highlighter-rouge">keytocard</code>.</p>
<ul>
  <li>Enter <code class="language-plaintext highlighter-rouge">y</code> to move the primary key</li>
  <li>Select <code class="language-plaintext highlighter-rouge">1</code>. This moves the signature subkey to the signature slot of the YubiKey.</li>
</ul>

<p>Enter <code class="language-plaintext highlighter-rouge">key 1</code> (which now shouljd select the encryption key) followed by <code class="language-plaintext highlighter-rouge">keytocard</code>. Select <code class="language-plaintext highlighter-rouge">2</code>. This moves the encryption key to the encryption slot.</p>

<p>Enter <code class="language-plaintext highlighter-rouge">key 1</code> again and then <code class="language-plaintext highlighter-rouge">key 2</code>. <code class="language-plaintext highlighter-rouge">keytocard</code> and <code class="language-plaintext highlighter-rouge">3</code>. This does the same but for the authentication key.</p>

<p>Now <code class="language-plaintext highlighter-rouge">quit</code> and <code class="language-plaintext highlighter-rouge">y</code> for save.</p>

<p>Now your secret keys are on your YubiKey and can be used for their intended purpose when it’s connected.</p>

<h2 id="configure-git-for-commit-signing">Configure Git for commit signing</h2>
<p>Configure git for GPG signing:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">git config --global commit.gpgsign true</code></li>
  <li><code class="language-plaintext highlighter-rouge">git config --global user.signingkey &lt;KEY ID&gt;</code></li>
</ul>

<p>And let’s restart the GPG agent: <code class="language-plaintext highlighter-rouge">gpg-connect-agent reloadagent</code>. Get out of there with <code class="language-plaintext highlighter-rouge">/bye</code>. Now when you make a commit, git will require the key to be present. If it’s not, the commit will fail. If you want to make a signed commit and see what it looks like in the log, the command for that is <code class="language-plaintext highlighter-rouge">git log --show-signature</code>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gpg: Signature made Sat Mar 14 03:30:27 2020 MDT
gpg:                using RSA key 05FFE31C369D8F25CFFF2167FDF8E68C5B840388
gpg: Good signature from "Jake Van Alstyne &lt;jakeva@gmail.com&gt;" [ultimate]
Author: Jake Van Alstyne 🎩 &lt;jakeva@gmail.com&gt;
Date:   Sat Mar 14 03:27:35 2020 -0600

    Add YubiKey Post
</code></pre></div></div>

<h2 id="configure-github-for-the-verified-stamp">Configure Github for the ‘Verified’ stamp</h2>
<p><code class="language-plaintext highlighter-rouge">gpg --armor --export &lt;KEY ID&gt; | pbcopy</code> and take it to <a href="https://github.com/settings/gpg/new">add as a new GPG key on Github</a>. If you forget this stamp, your commits will still show as signed but ‘Unverified’.</p>

<h2 id="etc">Etc</h2>
<p>Something interesting I noticed is that the gpg-agent caches the key. I removed the key from my computer before making another commit and it still got signed. It looks like this is set in <code class="language-plaintext highlighter-rouge">~/.gnupg/gpg-agent.conf</code> so just a heads up.</p>


    <div class="pagination btn-group">
      
        <a class="btn prev" href="/haikus/2020/03/12/Wasting-20time/" title="Wasting time">&larr; Previous</a>
      
        <a class="btn" href="/archive/">Archive</a>
      
        <a class="btn next" href="/haikus/2020/03/26/Earthquakes/" title="Earthquakes">Next &rarr;</a>
      
    </div>
    


  
<div id="disqus_thread"></div>
<script type="text/javascript">
        var disqus_shortname = 'jakevanalstyne';
        var disqus_title = 'GPG & YubiKey & You';
        var disqus_url = '/blog/2020/03/14/gpg-yubikey-you/';
        var disqus_identifier = 'jakevanalstyne'-'GPG & YubiKey & You';
    
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




  </span>

  <span class="span2">
    <section>
      <h4>Published</h4>
      <div class="date"><span>14 March 2020</span></div>
    </section>
    
      <section>
        <h4>Category</h4>
        <span class="category">
          Blog
        </span>
      </section>
    
    
      <section>
        <h4>Tags</h4>
        <ul class="tag_box">
          
          


  
     
    	<li><a href="/tags/#yubikey-ref">yubikey <span>1</span></a></li>
     
    	<li><a href="/tags/#git-ref">git <span>1</span></a></li>
     
    	<li><a href="/tags/#gpg-ref">gpg <span>1</span></a></li>
    
  



        </ul>
      </section>
    
  </span>
</div>


      </div>

      <footer class="footer">
        <ul class="footer-nav">
          
          
          


  
    
      
    
  
    
      
      	
      	<li><a href="/archive/">Archive</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/categories/">Categories</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/pages/">Pages</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags/">Tags</a></li>
      	
      
    
  
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  



        </ul>
        <p>
          &copy; Jake Van Alstyne 2010-2020
        </p>
      </footer>
    </div> <!-- /container -->
    


  <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-39509409-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>



  </body>
</html>

